{
  "guid": "afa2526c-4fba-4369-b06b-818dafd7eb59",
  "name": "Redis KV",
  "resolutionPath": "/kv*",
  "serviceType": "WEB_API",
  "checksum": "ad8fa650382e35779d9dcbae7c679865d65f21c7",
  "enabled": true,
  "folderPath": "/",
  "methodsAllowed": [
    "GET",
    "POST",
    "PUT",
    "DELETE"
  ],
  "tracingEnabled": false,
  "wssProcessingEnabled": false,
  "laxResolution": false,
  "policy": {
    "code": {
      "All": [
        {
          "FaultLevel": {
            "levelInfo": {
              ".type": "soapFaultLevel",
              "level": 4
            }
          }
        },
        {
          "SetVariable": {
            "expression": "${request.http.parameters.value}",
            "variable": "valueToStore"
          }
        },
        {
          "SetVariable": {
            "expression": "${request.url.path}",
            "variable": "urlPath"
          }
        },
        {
          "SetVariable": {
            "contentType": "text/xml; charset=utf-8",
            "dataType": "message",
            "expression": "<codes>\r\n\t<code id=\"0\">Success</code>\r\n\t<code id=\"1\">Invalid Store ID</code>\r\n\t<code id=\"2\">Max Entries Exceeded</code>\r\n\t<code id=\"3\">Max Entry Size Exceeded</code>\r\n\t<code id=\"4\">Unregistered provider [not properly configured; not available]</code>\r\n\t<code id=\"5\">Invalid key</code>\r\n\t<code id=\"6\">Invalid max age value</code>\r\n\t<code id=\"7\">General error (catch all)</code>\r\n</codes>\r\n\r\n",
            "variable": "storageCodes"
          }
        },
        {
          "OneOrMore": [
            {
              "All": [
                {
                  "ComparisonAssertion": {
                    "expression1": "${urlPath}",
                    "expression2": "/kv/store",
                    "predicates": [
                      {
                        ".type": ":binary",
                        "rightValue": "/kv/store"
                      }
                    ]
                  }
                },
                {
                  "AuditDetail": {
                    "detail": "Path is ${urlPath} - storing the value \"${valueToStore}\" in KV.",
                    "loggingOnly": true
                  }
                },
                {
                  "OneOrMore": [
                    {
                      "All": [
                        {
                          "KeyValueStorage": {
                            "continueOnError": false,
                            "key": "cob",
                            "maxAge": "10m",
                            "otherTargetMessageVariable": "valueToStore",
                            "storeId": "redis",
                            "target": "OTHER"
                          }
                        },
                        {
                          "AuditDetail": {
                            "detail": "Value \"${valueToStore}\" stored in KV.",
                            "loggingOnly": true
                          }
                        },
                        {
                          "SetVariable": {
                            "expression": "/codes/code[@id=${kvstorage.assertion.status}]/text()",
                            "variable": "xPath"
                          }
                        },
                        {
                          "ResponseXpath": {
                            "variablePrefix": "kvResponse",
                            "xmlMsgSrc": "storageCodes",
                            "xpathExpression": {
                              ".type": "xpathExpression",
                              "expression": "${xPath}",
                              "namespaces": {
                                "s": "http://schemas.xmlsoap.org/soap/envelope/"
                              },
                              "xpathVersion": "XPATH_1_0"
                            }
                          }
                        },
                        {
                          "HardcodedResponse": {
                            "body": "Storage status: ${kvstorage.assertion.status} - ${kvResponse.result}\n\n"
                          }
                        }
                      ]
                    },
                    {
                      "All": [
                        {
                          "SetVariable": {
                            "expression": "/codes/code[@id=${kvstorage.assertion.status}]/text()",
                            "variable": "xPath"
                          }
                        },
                        {
                          "ResponseXpath": {
                            "variablePrefix": "kvResponse",
                            "xmlMsgSrc": "storageCodes",
                            "xpathExpression": {
                              ".type": "xpathExpression",
                              "expression": "${xPath}",
                              "namespaces": {
                                "s": "http://schemas.xmlsoap.org/soap/envelope/"
                              },
                              "xpathVersion": "XPATH_1_0"
                            }
                          }
                        },
                        {
                          "HardcodedResponse": {
                            "body": "Storage status: ${kvstorage.assertion.status} - ${kvResponse.result}\n\n"
                          }
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "All": [
                {
                  "ComparisonAssertion": {
                    "expression1": "${urlPath}",
                    "expression2": "/kv/read",
                    "predicates": [
                      {
                        ".type": ":binary",
                        "rightValue": "/kv/read"
                      }
                    ]
                  }
                },
                {
                  "AuditDetail": {
                    "detail": "Path is ${urlPath} - reading the value from KV.",
                    "loggingOnly": true
                  }
                },
                {
                  "KeyValueLookup": {
                    "key": "cob",
                    "storeId": "redis"
                  }
                }
              ]
            }
          ]
        }
      ]
    }
  }
}